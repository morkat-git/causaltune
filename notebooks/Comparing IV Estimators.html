<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Comparing IV Estimators &mdash; CausalTune 2022 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="ERUPT under simulated random assignment" href="ERUPT%20under%20simulated%20random%20assignment.html" />
    <link rel="prev" title="Setting up the data and causal model: CausalityDataset" href="CausalityDataset%20setup.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            CausalTune
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whatcanthisdo.html">What can this do for you?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../howitworks.html">Model selection</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../notebook_examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="AB%20testing.html">AB Testing with CausalTune</a></li>
<li class="toctree-l2"><a class="reference internal" href="CausalityDataset%20setup.html">Setting up the data and causal model: CausalityDataset</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Comparing IV Estimators</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Data-Generation-Process">Data Generation Process</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Model-Fitting-(1):-Constant-Effect-(ATE)">Model Fitting (1): Constant Effect (ATE)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Baseline-Estimators">Baseline Estimators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Model-Fitting-(2):-Heterogeneous-Treatment-Effect">Model Fitting (2): Heterogeneous Treatment Effect</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Model-Fitting-(3):-Non-linear-Heterogeneous-Treatment-Effect">Model Fitting (3): Non-linear Heterogeneous Treatment Effect</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ERUPT%20under%20simulated%20random%20assignment.html">ERUPT under simulated random assignment</a></li>
<li class="toctree-l2"><a class="reference internal" href="Propensity%20Model%20Selection.html">Propensity Score Weighting in CausalTune</a></li>
<li class="toctree-l2"><a class="reference internal" href="Random%20assignment%2C%20binary%20CATE%20example.html">Random assignment, binary CATE example</a></li>
<li class="toctree-l2"><a class="reference internal" href="Standard%20errors.html">Standard errors</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../causaltune.html">Public Module Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CausalTune</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../notebook_examples.html">Examples</a></li>
      <li class="breadcrumb-item active">Comparing IV Estimators</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/Comparing IV Estimators.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Comparing-IV-Estimators">
<h1>Comparing IV Estimators<a class="headerlink" href="#Comparing-IV-Estimators" title="Permalink to this headline">ÔÉÅ</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">dcor</span>


<span class="n">root_path</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s1">&#39;../..&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">causaltune</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s2">&quot;causaltune&quot;</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">dowhy</span> <span class="kn">import</span> <span class="n">CausalModel</span>


<span class="kn">from</span> <span class="nn">causaltune</span> <span class="kn">import</span> <span class="n">CausalTune</span>
<span class="kn">from</span> <span class="nn">causaltune.datasets</span> <span class="kn">import</span> <span class="n">iv_dgp_econml</span>
<span class="kn">from</span> <span class="nn">causaltune.scoring</span> <span class="kn">import</span> <span class="n">Scorer</span>
<span class="kn">from</span> <span class="nn">causaltune.datasets</span> <span class="kn">import</span> <span class="n">iv_dgp_econml</span>
<span class="kn">from</span> <span class="nn">causaltune.params</span> <span class="kn">import</span> <span class="n">SimpleParamService</span>
<span class="kn">from</span> <span class="nn">causaltune.utils</span> <span class="kn">import</span> <span class="n">treatment_is_multivalue</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The autoreload extension is already loaded. To reload it, use:
  %reload_ext autoreload
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="nx">javascript</span>

<span class="c1">// turn off scrollable windows for large output</span>
<span class="nx">IPython</span><span class="p">.</span><span class="nx">OutputArea</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_should_scroll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="output_javascript"></div>
<script type="text/javascript">
var element = document.currentScript.previousSibling.previousSibling;

// turn off scrollable windows for large output
IPython.OutputArea.prototype._should_scroll = function(lines) {
    return false;
}

</script></div>
</div>
<section id="Data-Generation-Process">
<h2>Data Generation Process<a class="headerlink" href="#Data-Generation-Process" title="Permalink to this headline">ÔÉÅ</a></h2>
<p>Here we use a data generation process implemented by EconML for IV models and described as follows:</p>
<p>We construct the DGP as below. The instrument corresponds to a fully randomized recommendation of treatment. Then each sample complies with the recommendation to some degree. This probability depends on both the observed feature <span class="math notranslate nohighlight">\(X\)</span> and an unobserved confounder that has a direct effect on the outcome</p>
<p><span class="math">\begin{align}
W \sim \; & \text{Normal}(0,\, I_{n_w})   \tag{Observed confounders}\\
Z \sim \; & \text{Bernoulli}(p=0.5)   \tag{Instrument}\\
\nu \sim \; & \text{U}[0, 5] \tag{Unobserved confounder}\\
C \sim \; & \text{Bernoulli}(p=0.8 \cdot \text{Sigmoid}(0.4 \cdot X[0] + \nu))   \tag{Compliers when recommended}\\
C0 \sim \; & \text{Bernoulli}(p=0.006)   \tag{Non-Compliers when not recommended}\\
\theta = & \; 7.5\cdot X[2]\cdot X[8] \\
T = \; & C \cdot Z + C0 \cdot (1-Z)  \tag{Treatment}\\
y \sim \; & \theta \cdot T + 2 \cdot \nu + 5 \cdot (X[3]>0) + 0.1 \cdot \text{U}[0, 1]  \tag{Outcome}
\end{align}</span></p>
<section id="Model-Fitting-(1):-Constant-Effect-(ATE)">
<h3>Model Fitting (1): Constant Effect (ATE)<a class="headerlink" href="#Model-Fitting-(1):-Constant-Effect-(ATE)" title="Permalink to this headline">ÔÉÅ</a></h3>
<p>We define a constant treatment effect (ATE) to be searched by CausalTune for all named IV estimators.</p>
<p><span class="math">\begin{align}
\theta = \; & 7.5 \tag{ATE}\\
\end{align}</span></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TRUE_EFFECT</span> <span class="o">=</span> <span class="mf">7.5</span>

<span class="n">CONSTANT_EFFECT</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="n">TRUE_EFFECT</span>

<span class="n">cd</span> <span class="o">=</span> <span class="n">iv_dgp_econml</span><span class="p">(</span>
    <span class="n">n</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>
    <span class="n">p</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">true_effect</span><span class="o">=</span><span class="n">CONSTANT_EFFECT</span>
    <span class="p">)</span>

<span class="n">cd</span><span class="o">.</span><span class="n">preprocess_dataset</span><span class="p">()</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">outcomes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>For each treatment effect example, we fit a list of 4 IV models, scoring them with an energy distance score. The dataset is split into train, validation and a hold-out test set, and we report scores for each.</p>
<p>The components time budget represent tuning budget allocated to each estimator model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">estimator_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;iv.econml.iv.dr.SparseLinearDRIV&#39;</span><span class="p">,</span>
    <span class="s2">&quot;iv.econml.iv.dml.DMLIV&quot;</span><span class="p">,</span>
    <span class="s2">&quot;iv.econml.iv.dml.OrthoIV&quot;</span><span class="p">,</span>
    <span class="s2">&quot;iv.econml.iv.dr.LinearDRIV&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<span class="n">ct_constant_te</span> <span class="o">=</span> <span class="n">CausalTune</span><span class="p">(</span>
    <span class="n">estimator_list</span><span class="o">=</span><span class="n">estimator_list</span><span class="p">,</span>
    <span class="n">components_time_budget</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
    <span class="n">propensity_model</span><span class="o">=</span><span class="s2">&quot;dummy&quot;</span><span class="p">,</span>
    <span class="n">metrics_to_report</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ate&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">ct_constant_te</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cd</span><span class="p">,</span> <span class="n">outcome</span><span class="o">=</span><span class="n">outcome</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Initial configs: [{&#39;estimator&#39;: {&#39;estimator_name&#39;: &#39;iv.econml.iv.dr.LinearDRIV&#39;, &#39;projection&#39;: True}}, {&#39;estimator&#39;: {&#39;estimator_name&#39;: &#39;iv.econml.iv.dml.OrthoIV&#39;, &#39;mc_agg&#39;: &#39;mean&#39;}}, {&#39;estimator&#39;: {&#39;estimator_name&#39;: &#39;iv.econml.iv.dml.DMLIV&#39;, &#39;mc_agg&#39;: &#39;mean&#39;}}, {&#39;estimator&#39;: {&#39;estimator_name&#39;: &#39;iv.econml.iv.dr.SparseLinearDRIV&#39;, &#39;projection&#39;: 0, &#39;opt_reweighted&#39;: 0, &#39;cov_clip&#39;: 0.1}}, {&#39;estimator&#39;: {&#39;estimator_name&#39;: &#39;iv.econml.iv.dr.LinearIntentToTreatDRIV&#39;, &#39;cov_clip&#39;: 0.1, &#39;opt_reweighted&#39;: 1}}]
</pre></div></div>
</div>
<p>We get the estimated effect for the best estimator by energy distance score</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_est_effects</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">test_x</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">te</span><span class="o">=</span><span class="n">TRUE_EFFECT</span><span class="p">):</span>
    <span class="n">est_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">est_name</span><span class="p">,</span> <span class="n">scr</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">est_effect</span> <span class="o">=</span> <span class="n">scr</span><span class="p">[</span><span class="s2">&quot;estimator&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">test_x</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">est_score_metric</span> <span class="o">=</span> <span class="n">scr</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">][</span><span class="s1">&#39;validation&#39;</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span>
        <span class="n">est_scores</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">est_name</span><span class="p">,</span> <span class="n">est_effect</span><span class="p">,</span> <span class="p">(</span><span class="n">est_effect</span><span class="o">-</span><span class="n">te</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">est_score_metric</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">est_scores</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;estimator&quot;</span><span class="p">,</span> <span class="s2">&quot;estimated_effect&quot;</span><span class="p">,</span> <span class="s2">&quot;ate_mse&quot;</span><span class="p">,</span> <span class="n">metric</span><span class="p">])</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">est</span><span class="p">,</span> <span class="n">scr</span> <span class="ow">in</span> <span class="n">ct_constant_te</span><span class="o">.</span><span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">scr</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;train&#39;: {&#39;ate&#39;: 3.6587573018220296, &#39;ate_std&#39;: 0.2120941770303501, &#39;energy_distance&#39;: 0.7061227121685265}, &#39;validation&#39;: {&#39;ate&#39;: 3.659523154322003, &#39;ate_std&#39;: 0.21267216723581409, &#39;energy_distance&#39;: 0.7260301166932219}, &#39;test&#39;: {&#39;ate&#39;: 3.6601023136720645, &#39;ate_std&#39;: 0.2113365684949257, &#39;energy_distance&#39;: 0.8196693253533471}}
{&#39;train&#39;: {&#39;ate&#39;: 7.465281466258064, &#39;ate_std&#39;: 0.14842815267202944, &#39;energy_distance&#39;: 0.0005052401655989414}, &#39;validation&#39;: {&#39;ate&#39;: 7.4659291946002675, &#39;ate_std&#39;: 0.14728470024896367, &#39;energy_distance&#39;: 0.002821829812681642}, &#39;test&#39;: {&#39;ate&#39;: 7.465431273827661, &#39;ate_std&#39;: 0.14746076535079047, &#39;energy_distance&#39;: 0.00895877486749086}}
{&#39;train&#39;: {&#39;ate&#39;: 3.6578872921389367, &#39;ate_std&#39;: 0.12417663903417193, &#39;energy_distance&#39;: 0.7063608433154576}, &#39;validation&#39;: {&#39;ate&#39;: 3.658135815552011, &#39;ate_std&#39;: 0.12410049366507657, &#39;energy_distance&#39;: 0.7260461354608321}, &#39;test&#39;: {&#39;ate&#39;: 3.6589021085747153, &#39;ate_std&#39;: 0.12373082545821416, &#39;energy_distance&#39;: 0.8199499773748142}}
{&#39;train&#39;: {&#39;ate&#39;: 5.541317216362592, &#39;ate_std&#39;: 0.12810830319605102, &#39;energy_distance&#39;: 0.18671984242779338}, &#39;validation&#39;: {&#39;ate&#39;: 5.5418649826227915, &#39;ate_std&#39;: 0.12720937541566696, &#39;energy_distance&#39;: 0.19944812237269005}, &#39;test&#39;: {&#39;ate&#39;: 5.541652515773052, &#39;ate_std&#39;: 0.1273827917939598, &#39;energy_distance&#39;: 0.2522452547041256}}
</pre></div></div>
</div>
<p>First we see the estimated effect for each model, and respective MSE compared with true effect</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_est_effects</span><span class="p">(</span><span class="n">ct_constant_te</span><span class="p">,</span> <span class="n">ct_constant_te</span><span class="o">.</span><span class="n">test_df</span><span class="p">,</span> <span class="s1">&#39;energy_distance&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>estimator</th>
      <th>estimated_effect</th>
      <th>ate_mse</th>
      <th>energy_distance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>iv.econml.iv.dml.DMLIV</td>
      <td>3.659523</td>
      <td>14.749262</td>
      <td>0.726030</td>
    </tr>
    <tr>
      <th>1</th>
      <td>iv.econml.iv.dml.OrthoIV</td>
      <td>7.465929</td>
      <td>0.001161</td>
      <td>0.002822</td>
    </tr>
    <tr>
      <th>2</th>
      <td>iv.econml.iv.dr.LinearDRIV</td>
      <td>3.658136</td>
      <td>14.759920</td>
      <td>0.726046</td>
    </tr>
    <tr>
      <th>3</th>
      <td>iv.econml.iv.dr.SparseLinearDRIV</td>
      <td>5.541865</td>
      <td>3.834293</td>
      <td>0.199448</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Best estimator, config and score:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(CausalTune Best Estimator)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimator: </span><span class="si">{</span><span class="n">ct_constant_te</span><span class="o">.</span><span class="n">best_estimator</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Config: </span><span class="si">{</span><span class="n">ct_constant_te</span><span class="o">.</span><span class="n">best_config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Energy distance score: </span><span class="si">{</span><span class="n">ct_constant_te</span><span class="o">.</span><span class="n">best_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(CausalTune Best Estimator)
Estimator: iv.econml.iv.dml.OrthoIV
Config: {&#39;estimator&#39;: {&#39;estimator_name&#39;: &#39;iv.econml.iv.dml.OrthoIV&#39;, &#39;mc_agg&#39;: &#39;mean&#39;}}
Energy distance score: 0.002821829812681642
</pre></div></div>
</div>
<p>In the plots we show the energy distance scores on the train, validation and hold-out test sets compared with the mean squared error between estimated effect and the true effect</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cd_holdout_constant_te</span> <span class="o">=</span> <span class="n">iv_dgp_econml</span><span class="p">(</span>
    <span class="n">n</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">p</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">true_effect</span><span class="o">=</span><span class="n">CONSTANT_EFFECT</span>
    <span class="p">)</span>

<span class="n">cd_holdout_constant_te</span><span class="o">.</span><span class="n">preprocess_dataset</span><span class="p">()</span>
<span class="n">ct_constant_te</span><span class="o">.</span><span class="n">score_dataset</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">cd_holdout_constant_te</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">causaltune.visualizer</span> <span class="kn">import</span> <span class="n">Visualizer</span>

<span class="n">viz</span> <span class="o">=</span> <span class="n">Visualizer</span><span class="p">(</span>
    <span class="n">test_df</span><span class="o">=</span><span class="n">cd_holdout_constant_te</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
    <span class="n">treatment_col_name</span><span class="o">=</span><span class="n">cd_holdout_constant_te</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
    <span class="n">outcome_col_name</span><span class="o">=</span><span class="n">cd_holdout_constant_te</span><span class="o">.</span><span class="n">outcomes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="c1"># plotting metrics by estimator</span>

<span class="n">figtitle</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">viz</span><span class="o">.</span><span class="n">outcome_col_name</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;energy_distance&#39;</span><span class="p">,</span> <span class="s1">&#39;ate&#39;</span><span class="p">)</span>

<span class="n">viz</span><span class="o">.</span><span class="n">plot_metrics_by_estimator</span><span class="p">(</span>
    <span class="n">scores_dict</span><span class="o">=</span><span class="n">ct_constant_te</span><span class="o">.</span><span class="n">scores</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
    <span class="n">figtitle</span><span class="o">=</span><span class="n">figtitle</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_Comparing_IV_Estimators_21_0.png" src="../_images/notebooks_Comparing_IV_Estimators_21_0.png" />
</div>
</div>
</section>
<section id="Baseline-Estimators">
<h3>Baseline Estimators<a class="headerlink" href="#Baseline-Estimators" title="Permalink to this headline">ÔÉÅ</a></h3>
<p>For comparison, we take the best default configuration of all integrated IV estimators as a baseline, and compare the ATE and energy distance scores, with the best CausalTune configuration.</p>
<p>We perform this comparison for the constant treatment effect only but a similar analysis would be feasible for heterogeneous treatment effect models as well. Note that this analysis hinges on the fact that we use synthetic data and know the true treatment effect.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="n">SimpleParamService</span><span class="p">(</span><span class="n">propensity_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outcome_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multivalue</span><span class="o">=</span><span class="n">treatment_is_multivalue</span><span class="p">(</span><span class="n">cd</span><span class="o">.</span><span class="n">treatment</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">baseline_scores</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">iv_estimators</span><span class="p">):</span>
    <span class="c1"># Baseline comparisons: IV models with default conigurations</span>
    <span class="n">baseline_scores</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">est_name</span> <span class="ow">in</span> <span class="n">iv_estimators</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">CausalModel</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">ct</span><span class="o">.</span><span class="n">train_df</span><span class="p">,</span>
            <span class="n">treatment</span><span class="o">=</span><span class="n">cd</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
            <span class="n">outcome</span><span class="o">=</span><span class="n">outcome</span><span class="p">,</span>
            <span class="n">effect_modifiers</span><span class="o">=</span><span class="n">cd</span><span class="o">.</span><span class="n">effect_modifiers</span><span class="p">,</span>
            <span class="n">common_causes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;random&quot;</span><span class="p">],</span>
            <span class="n">instruments</span><span class="o">=</span><span class="n">cd</span><span class="o">.</span><span class="n">instruments</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">identified_estimand</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">identify_effect</span><span class="p">(</span><span class="n">proceed_when_unidentifiable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">estimate</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">estimate_effect</span><span class="p">(</span>
            <span class="n">identified_estimand</span><span class="p">,</span>
            <span class="n">method_name</span><span class="o">=</span><span class="n">est_name</span><span class="p">,</span>
            <span class="n">method_params</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;init_params&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s2">&quot;fit_params&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="p">},</span>
            <span class="n">test_significance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">base_effect_</span> <span class="o">=</span> <span class="n">estimate</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">test_df</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">base_energy_dist</span> <span class="o">=</span> <span class="n">Scorer</span><span class="o">.</span><span class="n">energy_distance_score</span><span class="p">(</span><span class="n">estimate</span><span class="p">,</span> <span class="n">ct</span><span class="o">.</span><span class="n">test_df</span><span class="p">)</span>

        <span class="n">baseline_scores</span><span class="p">[</span><span class="n">est_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;effect&quot;</span><span class="p">:</span> <span class="n">base_effect_</span><span class="p">,</span>
            <span class="s2">&quot;energy_distance&quot;</span><span class="p">:</span> <span class="n">base_energy_dist</span>
        <span class="p">}</span>

    <span class="n">baseline_estimator</span><span class="p">,</span> <span class="n">baseline_metrics</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">baseline_scores</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;energy_distance&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">baseline_estimator</span><span class="p">,</span> <span class="n">baseline_metrics</span><span class="p">,</span> <span class="n">estimate</span>


<span class="n">baseline_estimator</span><span class="p">,</span> <span class="n">baseline_metrics</span><span class="p">,</span> <span class="n">estimate</span> <span class="o">=</span> <span class="n">baseline_scores</span><span class="p">(</span><span class="n">ct_constant_te</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">estimator_list</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(Best baseline)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estimator: &quot;</span><span class="p">,</span> <span class="n">baseline_estimator</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Energy distance score: &quot;</span><span class="p">,</span> <span class="n">baseline_metrics</span><span class="p">[</span><span class="s2">&quot;energy_distance&quot;</span><span class="p">])</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(Best baseline)
Estimator:  iv.econml.iv.dml.DMLIV
Energy distance score:  0.002399240023787108
</pre></div></div>
</div>
<section id="Comparing-Treatment-Effect">
<h4>Comparing Treatment Effect<a class="headerlink" href="#Comparing-Treatment-Effect" title="Permalink to this headline">ÔÉÅ</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;True Treatment Effect  = &quot;</span><span class="p">,</span> <span class="n">TRUE_EFFECT</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(Baseline) Treatment Effect: &quot;</span><span class="p">,</span> <span class="n">baseline_metrics</span><span class="p">[</span><span class="s2">&quot;effect&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(CausalTune) Treatment Effect: &quot;</span><span class="p">,</span> <span class="n">ct_constant_te</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">ct_constant_te</span><span class="o">.</span><span class="n">test_df</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True Treatment Effect  =  7.5
(Baseline) Treatment Effect:  7.5388046776020285
(CausalTune) Treatment Effect:  7.4659291946002675
</pre></div></div>
</div>
<p>Next, we - compare the energy distance score for the baseline estimator and the CausalTune estimator, and - build upper and lower bound benchmarks of the energy score.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Needed since ct.model.estimator doesn&#39;t include additional params -</span>
<span class="c1"># treatment, outcome etc. - needed from CausalEstimate instance</span>
<span class="k">def</span> <span class="nf">energy_scorer_patch</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">treatment</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">outcome</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">effect_modifiers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;estimate&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;dy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">effect_modifiers</span><span class="p">])</span>
    <span class="c1"># Compute Energy distance for True &amp; No Effect</span>
    <span class="k">elif</span> <span class="s2">&quot;true_effect&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;ne&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;dy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ne&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
            <span class="k">else</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;true_effect&quot;</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">treatment</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;dy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;yhat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">outcome</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;dy&quot;</span><span class="p">]</span>

    <span class="n">X1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">instrument</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">X0</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">instrument</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">select_cols</span> <span class="o">=</span> <span class="n">effect_modifiers</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;yhat&quot;</span><span class="p">]</span>

    <span class="n">energy_distance_score</span> <span class="o">=</span> <span class="n">dcor</span><span class="o">.</span><span class="n">energy_distance</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="n">select_cols</span><span class="p">],</span> <span class="n">X0</span><span class="p">[</span><span class="n">select_cols</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">energy_distance_score</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Energy distance scores&quot;</span><span class="p">)</span>
<span class="n">base_estimator_edist</span> <span class="o">=</span> <span class="n">Scorer</span><span class="o">.</span><span class="n">energy_distance_score</span><span class="p">(</span><span class="n">estimate</span><span class="p">,</span> <span class="n">ct_constant_te</span><span class="o">.</span><span class="n">test_df</span><span class="p">)</span>
<span class="n">ac_estimator_edist</span> <span class="o">=</span> <span class="n">energy_scorer_patch</span><span class="p">(</span>
    <span class="n">ct_constant_te</span><span class="o">.</span><span class="n">test_df</span><span class="p">,</span> <span class="n">cd</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">cd</span><span class="o">.</span><span class="n">instruments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cd</span><span class="o">.</span><span class="n">effect_modifiers</span><span class="p">,</span> <span class="n">estimate</span><span class="o">=</span><span class="n">ct_constant_te</span><span class="o">.</span><span class="n">model</span>
<span class="p">)</span>
<span class="n">ac_estimator_edist_ne</span> <span class="o">=</span> <span class="n">energy_scorer_patch</span><span class="p">(</span>
    <span class="n">ct_constant_te</span><span class="o">.</span><span class="n">test_df</span><span class="p">,</span> <span class="n">cd</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">cd</span><span class="o">.</span><span class="n">instruments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cd</span><span class="o">.</span><span class="n">effect_modifiers</span><span class="p">,</span> <span class="n">true_effect</span><span class="o">=</span><span class="n">TRUE_EFFECT</span><span class="p">,</span> <span class="n">ne</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">ac_estimator_edist_te</span> <span class="o">=</span> <span class="n">energy_scorer_patch</span><span class="p">(</span>
    <span class="n">ct_constant_te</span><span class="o">.</span><span class="n">test_df</span><span class="p">,</span> <span class="n">cd</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">cd</span><span class="o">.</span><span class="n">instruments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cd</span><span class="o">.</span><span class="n">effect_modifiers</span><span class="p">,</span> <span class="n">true_effect</span><span class="o">=</span><span class="n">TRUE_EFFECT</span><span class="p">,</span> <span class="n">ne</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The baseline and CausalTune energy scores are:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(Baseline) Energy distance score: </span><span class="si">{</span><span class="n">base_estimator_edist</span><span class="si">:</span><span class="s2">5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(CausalTune) Energy distance score: </span><span class="si">{</span><span class="n">ac_estimator_edist</span><span class="si">:</span><span class="s2">5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The energy distance between treatment and control is&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(No Effect) Energy distance score: </span><span class="si">{</span><span class="n">ac_estimator_edist_ne</span><span class="si">:</span><span class="s2">5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This can be seen as an upper bound on the achievable energy score since </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;it calculates the energy score under the assumption that there is no treatment effect.</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;If we remove the true treatment effect (which is known in this case)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;from the treated units and compare the resulting outcomes with the control group,</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
      <span class="s2">&quot; the energy distance becomes&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(True Effect) Energy distance score: </span><span class="si">{</span><span class="n">ac_estimator_edist_te</span><span class="si">:</span><span class="s2">5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This can be seen as a lower bound on the achievable energy distance as </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;the de-treated treatment and the control outcome distributions follow the same data generating process.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Energy distance scores

The baseline and CausalTune energy scores are:

(Baseline) Energy distance score: 0.002633
(CausalTune) Energy distance score: 0.002744

The energy distance between treatment and control is
(No Effect) Energy distance score: 2.541892
This can be seen as an upper bound on the achievable energy score since
it calculates the energy score under the assumption that there is no treatment effect.



If we remove the true treatment effect (which is known in this case)
from the treated units and compare the resulting outcomes with the control group,
 the energy distance becomes
(True Effect) Energy distance score: 0.002466
This can be seen as a lower bound on the achievable energy distance as
the de-treated treatment and the control outcome distributions follow the same data generating process.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Feature importance with SHAP explainer</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">shap</span>

<span class="c1"># and now let&#39;s visualize feature importances!</span>
<span class="kn">from</span> <span class="nn">causaltune.shap</span> <span class="kn">import</span> <span class="n">shap_values</span>

<span class="c1"># Shapley values calculation can be slow so let&#39;s subsample</span>
<span class="n">this_df</span> <span class="o">=</span> <span class="n">ct_constant_te</span><span class="o">.</span><span class="n">test_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="n">scr</span> <span class="o">=</span> <span class="n">ct_constant_te</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">ct_constant_te</span><span class="o">.</span><span class="n">best_estimator</span><span class="p">]</span>
<span class="n">est</span> <span class="o">=</span> <span class="n">ct_constant_te</span><span class="o">.</span><span class="n">model</span>
<span class="n">shaps</span> <span class="o">=</span> <span class="n">shap_values</span><span class="p">(</span><span class="n">est</span><span class="p">,</span> <span class="n">this_df</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">outcome</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">ct_constant_te</span><span class="o">.</span><span class="n">best_estimator</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span><span class="n">shaps</span><span class="p">,</span> <span class="n">this_df</span><span class="p">[</span><span class="n">cd</span><span class="o">.</span><span class="n">effect_modifiers</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_Comparing_IV_Estimators_31_0.png" src="../_images/notebooks_Comparing_IV_Estimators_31_0.png" />
</div>
</div>
</section>
</section>
<section id="Model-Fitting-(2):-Heterogeneous-Treatment-Effect">
<h3>Model Fitting (2): Heterogeneous Treatment Effect<a class="headerlink" href="#Model-Fitting-(2):-Heterogeneous-Treatment-Effect" title="Permalink to this headline">ÔÉÅ</a></h3>
<p>Here we replace the constant treatment effect with a linear treatment effect function of some covariates to estimate heterogeneous effects.</p>
<p><span class="math">\begin{align}
\theta = \; & 7.5  \cdot   (X[2] + X[7]) \tag{ATE}\\
\end{align}</span></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LINEAR_EFFECT</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="n">TRUE_EFFECT</span> <span class="o">*</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">])</span>

<span class="n">cd</span> <span class="o">=</span> <span class="n">iv_dgp_econml</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">true_effect</span><span class="o">=</span><span class="n">LINEAR_EFFECT</span><span class="p">)</span>
<span class="n">cd</span><span class="o">.</span><span class="n">preprocess_dataset</span><span class="p">()</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">outcomes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ct_linear_te</span> <span class="o">=</span> <span class="n">CausalTune</span><span class="p">(</span>
    <span class="n">estimator_list</span><span class="o">=</span><span class="n">estimator_list</span><span class="p">,</span>
    <span class="n">components_time_budget</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="n">propensity_model</span><span class="o">=</span><span class="s2">&quot;dummy&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ct_linear_te</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cd</span><span class="p">,</span> <span class="n">outcome</span><span class="o">=</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Initial configs: [{&#39;estimator&#39;: {&#39;estimator_name&#39;: &#39;iv.econml.iv.dr.LinearDRIV&#39;, &#39;projection&#39;: True}}, {&#39;estimator&#39;: {&#39;estimator_name&#39;: &#39;iv.econml.iv.dml.OrthoIV&#39;, &#39;mc_agg&#39;: &#39;mean&#39;}}, {&#39;estimator&#39;: {&#39;estimator_name&#39;: &#39;iv.econml.iv.dml.DMLIV&#39;, &#39;mc_agg&#39;: &#39;mean&#39;}}, {&#39;estimator&#39;: {&#39;estimator_name&#39;: &#39;iv.econml.iv.dr.SparseLinearDRIV&#39;, &#39;projection&#39;: 0, &#39;opt_reweighted&#39;: 0, &#39;cov_clip&#39;: 0.1}}]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_est_effects</span><span class="p">(</span><span class="n">ct_linear_te</span><span class="p">,</span> <span class="n">ct_linear_te</span><span class="o">.</span><span class="n">test_df</span><span class="p">,</span> <span class="s1">&#39;energy_distance&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>estimator</th>
      <th>estimated_effect</th>
      <th>ate_mse</th>
      <th>energy_distance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>iv.econml.iv.dml.DMLIV</td>
      <td>-0.559407</td>
      <td>64.954037</td>
      <td>0.080734</td>
    </tr>
    <tr>
      <th>1</th>
      <td>iv.econml.iv.dml.OrthoIV</td>
      <td>-0.865709</td>
      <td>69.985092</td>
      <td>0.043433</td>
    </tr>
    <tr>
      <th>2</th>
      <td>iv.econml.iv.dr.LinearDRIV</td>
      <td>-0.479235</td>
      <td>63.668190</td>
      <td>0.101972</td>
    </tr>
    <tr>
      <th>3</th>
      <td>iv.econml.iv.dr.SparseLinearDRIV</td>
      <td>-0.543763</td>
      <td>64.702125</td>
      <td>0.073483</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[83]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cd_holdout_linear_te</span> <span class="o">=</span> <span class="n">iv_dgp_econml</span><span class="p">(</span>
    <span class="n">n</span><span class="o">=</span><span class="mi">30000</span><span class="p">,</span>
    <span class="n">p</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">true_effect</span><span class="o">=</span><span class="n">LINEAR_EFFECT</span>
    <span class="p">)</span>

<span class="n">cd_holdout_linear_te</span><span class="o">.</span><span class="n">preprocess_dataset</span><span class="p">()</span>
<span class="n">ct_linear_te</span><span class="o">.</span><span class="n">score_dataset</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">cd_holdout_linear_te</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

<span class="n">viz</span> <span class="o">=</span> <span class="n">Visualizer</span><span class="p">(</span>
    <span class="n">test_df</span><span class="o">=</span><span class="n">cd_holdout_linear_te</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
    <span class="n">treatment_col_name</span><span class="o">=</span><span class="n">cd_holdout_linear_te</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
    <span class="n">outcome_col_name</span><span class="o">=</span><span class="n">cd_holdout_linear_te</span><span class="o">.</span><span class="n">outcomes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[84]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="c1"># plotting metrics by estimator</span>

<span class="n">figtitle</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">viz</span><span class="o">.</span><span class="n">outcome_col_name</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;energy_distance&#39;</span><span class="p">,</span> <span class="s1">&#39;ate&#39;</span><span class="p">)</span>

<span class="n">viz</span><span class="o">.</span><span class="n">plot_metrics_by_estimator</span><span class="p">(</span>
    <span class="n">scores_dict</span><span class="o">=</span><span class="n">ct_linear_te</span><span class="o">.</span><span class="n">scores</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
    <span class="n">figtitle</span><span class="o">=</span><span class="n">figtitle</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_Comparing_IV_Estimators_37_0.png" src="../_images/notebooks_Comparing_IV_Estimators_37_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shapley values calculation can be slow so let&#39;s subsample</span>
<span class="n">this_df</span> <span class="o">=</span> <span class="n">ct_linear_te</span><span class="o">.</span><span class="n">test_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="n">scr</span> <span class="o">=</span> <span class="n">ct_linear_te</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">ct_linear_te</span><span class="o">.</span><span class="n">best_estimator</span><span class="p">]</span>
<span class="n">est</span> <span class="o">=</span> <span class="n">ct_linear_te</span><span class="o">.</span><span class="n">model</span>
<span class="n">shaps</span> <span class="o">=</span> <span class="n">shap_values</span><span class="p">(</span><span class="n">est</span><span class="p">,</span> <span class="n">this_df</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">outcome</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">ct_linear_te</span><span class="o">.</span><span class="n">best_estimator</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span><span class="n">shaps</span><span class="p">,</span> <span class="n">this_df</span><span class="p">[</span><span class="n">cd</span><span class="o">.</span><span class="n">effect_modifiers</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_Comparing_IV_Estimators_38_0.png" src="../_images/notebooks_Comparing_IV_Estimators_38_0.png" />
</div>
</div>
</section>
<section id="Model-Fitting-(3):-Non-linear-Heterogeneous-Treatment-Effect">
<h3>Model Fitting (3): Non-linear Heterogeneous Treatment Effect<a class="headerlink" href="#Model-Fitting-(3):-Non-linear-Heterogeneous-Treatment-Effect" title="Permalink to this headline">ÔÉÅ</a></h3>
<p>Finally we explore non-linear heterogeneous treatment effects with the function below:</p>
<p><span class="math">\begin{align}
\theta = \; & 7.5  \cdot   (X[2] + X[7]) \tag{ATE}\\
\end{align}</span></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[86]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">QUADRATIC_EFFECT</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="n">TRUE_EFFECT</span> <span class="o">*</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">cd</span> <span class="o">=</span> <span class="n">iv_dgp_econml</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">true_effect</span><span class="o">=</span><span class="n">QUADRATIC_EFFECT</span><span class="p">)</span>
<span class="n">cd</span><span class="o">.</span><span class="n">preprocess_dataset</span><span class="p">()</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">outcomes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[86]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>y</th>
      <th>treatment</th>
      <th>Z</th>
      <th>random</th>
      <th>x1</th>
      <th>x2</th>
      <th>x3</th>
      <th>x4</th>
      <th>x5</th>
      <th>x6</th>
      <th>x7</th>
      <th>x8</th>
      <th>x9</th>
      <th>x10</th>
      <th>x11</th>
      <th>x12</th>
      <th>x13</th>
      <th>x14</th>
      <th>x15</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6.217977</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.449373</td>
      <td>-0.664156</td>
      <td>0.142750</td>
      <td>0.333380</td>
      <td>0.076627</td>
      <td>-0.072835</td>
      <td>0.640475</td>
      <td>1.006988</td>
      <td>0.745913</td>
      <td>-0.484027</td>
      <td>-0.260730</td>
      <td>1.194747</td>
      <td>0.382013</td>
      <td>0.556873</td>
      <td>-0.139058</td>
    </tr>
    <tr>
      <th>1</th>
      <td>23.855850</td>
      <td>1</td>
      <td>1</td>
      <td>0.0</td>
      <td>-0.850771</td>
      <td>-0.686780</td>
      <td>-1.465715</td>
      <td>-0.736871</td>
      <td>0.608843</td>
      <td>-0.277723</td>
      <td>-0.585572</td>
      <td>-0.182962</td>
      <td>1.165760</td>
      <td>-0.264437</td>
      <td>0.553148</td>
      <td>-1.921674</td>
      <td>-0.733251</td>
      <td>-0.925882</td>
      <td>1.236508</td>
    </tr>
    <tr>
      <th>2</th>
      <td>43.222108</td>
      <td>1</td>
      <td>1</td>
      <td>0.0</td>
      <td>-0.165029</td>
      <td>0.070267</td>
      <td>-2.246133</td>
      <td>1.387414</td>
      <td>0.529701</td>
      <td>-0.485374</td>
      <td>0.481825</td>
      <td>1.397670</td>
      <td>1.717529</td>
      <td>0.308166</td>
      <td>1.293859</td>
      <td>0.464600</td>
      <td>-0.765668</td>
      <td>0.292529</td>
      <td>-0.958925</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.258738</td>
      <td>0</td>
      <td>0</td>
      <td>1.0</td>
      <td>1.051790</td>
      <td>1.197665</td>
      <td>-0.646686</td>
      <td>-0.619009</td>
      <td>0.573426</td>
      <td>1.005463</td>
      <td>1.716961</td>
      <td>-0.136543</td>
      <td>0.417223</td>
      <td>-0.866058</td>
      <td>0.673982</td>
      <td>-0.346598</td>
      <td>-0.666294</td>
      <td>1.567623</td>
      <td>1.497358</td>
    </tr>
    <tr>
      <th>4</th>
      <td>26.760363</td>
      <td>1</td>
      <td>1</td>
      <td>1.0</td>
      <td>-2.147729</td>
      <td>0.624663</td>
      <td>1.546067</td>
      <td>-0.452222</td>
      <td>-0.787933</td>
      <td>0.136457</td>
      <td>0.055029</td>
      <td>-1.309542</td>
      <td>-0.511940</td>
      <td>0.185796</td>
      <td>0.588358</td>
      <td>-0.189125</td>
      <td>1.694611</td>
      <td>-0.362455</td>
      <td>1.704416</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[87]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ct_quad_te</span> <span class="o">=</span> <span class="n">CausalTune</span><span class="p">(</span>
    <span class="n">estimator_list</span><span class="o">=</span><span class="n">estimator_list</span><span class="p">,</span>
    <span class="n">components_time_budget</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="n">propensity_model</span><span class="o">=</span><span class="s2">&quot;dummy&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ct_quad_te</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cd</span><span class="p">,</span> <span class="n">outcome</span><span class="o">=</span><span class="n">outcome</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Initial configs: [{&#39;estimator&#39;: {&#39;estimator_name&#39;: &#39;iv.econml.iv.dr.LinearDRIV&#39;, &#39;projection&#39;: True}}, {&#39;estimator&#39;: {&#39;estimator_name&#39;: &#39;iv.econml.iv.dml.OrthoIV&#39;, &#39;mc_agg&#39;: &#39;mean&#39;}}, {&#39;estimator&#39;: {&#39;estimator_name&#39;: &#39;iv.econml.iv.dml.DMLIV&#39;, &#39;mc_agg&#39;: &#39;mean&#39;}}, {&#39;estimator&#39;: {&#39;estimator_name&#39;: &#39;iv.econml.iv.dr.SparseLinearDRIV&#39;, &#39;projection&#39;: 0, &#39;opt_reweighted&#39;: 0, &#39;cov_clip&#39;: 0.1}}]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[88]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_est_effects</span><span class="p">(</span><span class="n">ct_quad_te</span><span class="p">,</span> <span class="n">ct_quad_te</span><span class="o">.</span><span class="n">test_df</span><span class="p">,</span> <span class="s1">&#39;energy_distance&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[88]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>estimator</th>
      <th>estimated_effect</th>
      <th>ate_mse</th>
      <th>energy_distance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>iv.econml.iv.dml.DMLIV</td>
      <td>3.881024</td>
      <td>13.096986</td>
      <td>0.461051</td>
    </tr>
    <tr>
      <th>1</th>
      <td>iv.econml.iv.dml.OrthoIV</td>
      <td>7.305954</td>
      <td>0.037654</td>
      <td>0.330434</td>
    </tr>
    <tr>
      <th>2</th>
      <td>iv.econml.iv.dr.LinearDRIV</td>
      <td>3.945438</td>
      <td>12.634910</td>
      <td>0.458119</td>
    </tr>
    <tr>
      <th>3</th>
      <td>iv.econml.iv.dr.SparseLinearDRIV</td>
      <td>4.863756</td>
      <td>6.949784</td>
      <td>0.358877</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[89]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cd_holdout_quad_te</span> <span class="o">=</span> <span class="n">iv_dgp_econml</span><span class="p">(</span>
    <span class="n">n</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span>
    <span class="n">p</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">true_effect</span><span class="o">=</span><span class="n">QUADRATIC_EFFECT</span>
    <span class="p">)</span>

<span class="n">cd_holdout_quad_te</span><span class="o">.</span><span class="n">preprocess_dataset</span><span class="p">()</span>
<span class="n">ct_quad_te</span><span class="o">.</span><span class="n">score_dataset</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">cd_holdout_quad_te</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

<span class="n">viz</span> <span class="o">=</span> <span class="n">Visualizer</span><span class="p">(</span>
    <span class="n">test_df</span><span class="o">=</span><span class="n">cd_holdout_quad_te</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
    <span class="n">treatment_col_name</span><span class="o">=</span><span class="n">cd_holdout_quad_te</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span>
    <span class="n">outcome_col_name</span><span class="o">=</span><span class="n">cd_holdout_quad_te</span><span class="o">.</span><span class="n">outcomes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[90]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="c1"># plotting metrics by estimator</span>

<span class="n">figtitle</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">viz</span><span class="o">.</span><span class="n">outcome_col_name</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;energy_distance&#39;</span><span class="p">,</span> <span class="s1">&#39;ate&#39;</span><span class="p">)</span>

<span class="n">viz</span><span class="o">.</span><span class="n">plot_metrics_by_estimator</span><span class="p">(</span>
    <span class="n">scores_dict</span><span class="o">=</span><span class="n">ct_quad_te</span><span class="o">.</span><span class="n">scores</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
    <span class="n">figtitle</span><span class="o">=</span><span class="n">figtitle</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_Comparing_IV_Estimators_44_0.png" src="../_images/notebooks_Comparing_IV_Estimators_44_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[91]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shapley values calculation can be slow so let&#39;s subsample</span>
<span class="n">this_df</span> <span class="o">=</span> <span class="n">ct_quad_te</span><span class="o">.</span><span class="n">test_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="n">scr</span> <span class="o">=</span> <span class="n">ct_quad_te</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">ct_quad_te</span><span class="o">.</span><span class="n">best_estimator</span><span class="p">]</span>
<span class="n">est</span> <span class="o">=</span> <span class="n">ct_quad_te</span><span class="o">.</span><span class="n">model</span>
<span class="n">shaps</span> <span class="o">=</span> <span class="n">shap_values</span><span class="p">(</span><span class="n">est</span><span class="p">,</span> <span class="n">this_df</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">outcome</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">ct_quad_te</span><span class="o">.</span><span class="n">best_estimator</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span><span class="n">shaps</span><span class="p">,</span> <span class="n">this_df</span><span class="p">[</span><span class="n">cd</span><span class="o">.</span><span class="n">effect_modifiers</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_Comparing_IV_Estimators_45_0.png" src="../_images/notebooks_Comparing_IV_Estimators_45_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="CausalityDataset%20setup.html" class="btn btn-neutral float-left" title="Setting up the data and causal model: CausalityDataset" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="ERUPT%20under%20simulated%20random%20assignment.html" class="btn btn-neutral float-right" title="ERUPT under simulated random assignment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Wise Payments Limited, PyWhy Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>